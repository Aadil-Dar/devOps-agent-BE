package com.devops.agent.controller;

import com.devops.agent.model.VulnerabilityResponse;
import com.devops.agent.service.VulnerabilityService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import java.util.Arrays;
import java.util.List;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(VulnerabilityController.class)
class VulnerabilityControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private VulnerabilityService vulnerabilityService;

    @Test
    void testGetAllVulnerabilities_Success() throws Exception {
        // Arrange
        VulnerabilityResponse vuln1 = VulnerabilityResponse.builder()
                .findingId("finding-1")
                .title("Critical Vulnerability")
                .severity("CRITICAL")
                .status("NEW")
                .description("A critical security issue")
                .resourceType("AwsEc2Instance")
                .build();

        VulnerabilityResponse vuln2 = VulnerabilityResponse.builder()
                .findingId("finding-2")
                .title("High Vulnerability")
                .severity("HIGH")
                .status("NEW")
                .description("A high severity security issue")
                .resourceType("AwsS3Bucket")
                .build();

        List<VulnerabilityResponse> vulnerabilities = Arrays.asList(vuln1, vuln2);
        when(vulnerabilityService.getAllVulnerabilities()).thenReturn(vulnerabilities);

        // Act & Assert
        mockMvc.perform(get("/api/vulnerabilities")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.length()").value(2))
                .andExpect(jsonPath("$[0].findingId").value("finding-1"))
                .andExpect(jsonPath("$[0].title").value("Critical Vulnerability"))
                .andExpect(jsonPath("$[0].severity").value("CRITICAL"))
                .andExpect(jsonPath("$[1].findingId").value("finding-2"))
                .andExpect(jsonPath("$[1].severity").value("HIGH"));
    }

    @Test
    void testGetAllVulnerabilities_Error() throws Exception {
        // Arrange
        when(vulnerabilityService.getAllVulnerabilities())
                .thenThrow(new RuntimeException("AWS Security Hub error"));

        // Act & Assert
        mockMvc.perform(get("/api/vulnerabilities")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isInternalServerError());
    }

    @Test
    void testGetVulnerabilitiesBySeverity_Success() throws Exception {
        // Arrange
        VulnerabilityResponse vuln = VulnerabilityResponse.builder()
                .findingId("finding-1")
                .title("Critical Vulnerability")
                .severity("CRITICAL")
                .status("NEW")
                .description("A critical security issue")
                .resourceType("AwsEc2Instance")
                .build();

        when(vulnerabilityService.getVulnerabilitiesBySeverity("CRITICAL"))
                .thenReturn(List.of(vuln));

        // Act & Assert
        mockMvc.perform(get("/api/vulnerabilities/severity/CRITICAL")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].severity").value("CRITICAL"));
    }

    @Test
    void testGetVulnerabilitiesBySeverity_InvalidSeverity() throws Exception {
        // Arrange
        when(vulnerabilityService.getVulnerabilitiesBySeverity(anyString()))
                .thenThrow(new RuntimeException("Invalid severity"));

        // Act & Assert
        mockMvc.perform(get("/api/vulnerabilities/severity/INVALID")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isBadRequest());
    }

    @Test
    void testGetVulnerabilityById_Success() throws Exception {
        // Arrange
        VulnerabilityResponse vuln = VulnerabilityResponse.builder()
                .findingId("finding-1")
                .title("Critical Vulnerability")
                .severity("CRITICAL")
                .status("NEW")
                .description("A critical security issue")
                .resourceType("AwsEc2Instance")
                .build();

        when(vulnerabilityService.getVulnerabilityById("finding-1")).thenReturn(vuln);

        // Act & Assert
        mockMvc.perform(get("/api/vulnerabilities/finding-1")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.findingId").value("finding-1"))
                .andExpect(jsonPath("$.title").value("Critical Vulnerability"))
                .andExpect(jsonPath("$.severity").value("CRITICAL"));
    }

    @Test
    void testGetVulnerabilityById_NotFound() throws Exception {
        // Arrange
        when(vulnerabilityService.getVulnerabilityById(anyString()))
                .thenThrow(new RuntimeException("Finding not found"));

        // Act & Assert
        mockMvc.perform(get("/api/vulnerabilities/non-existent")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isNotFound());
    }
}
