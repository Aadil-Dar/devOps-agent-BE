package com.devops.agent.service;

import com.devops.agent.model.VulnerabilityResponse;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import software.amazon.awssdk.services.securityhub.SecurityHubClient;
import software.amazon.awssdk.services.securityhub.model.*;

import java.time.Instant;
import java.util.Collections;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class VulnerabilityServiceTest {

    @Mock
    private SecurityHubClient securityHubClient;

    private VulnerabilityService vulnerabilityService;

    @BeforeEach
    void setUp() {
        vulnerabilityService = new VulnerabilityService(securityHubClient);
    }

    @Test
    void testGetAllVulnerabilities_Success() {
        // Arrange
        AwsSecurityFinding finding = createMockFinding();
        GetFindingsResponse response = GetFindingsResponse.builder()
                .findings(List.of(finding))
                .build();

        when(securityHubClient.getFindings(any(GetFindingsRequest.class))).thenReturn(response);

        // Act
        List<VulnerabilityResponse> result = vulnerabilityService.getAllVulnerabilities();

        // Assert
        assertNotNull(result);
        assertEquals(1, result.size());
        assertEquals("test-finding-id", result.get(0).getFindingId());
        assertEquals("Test Vulnerability", result.get(0).getTitle());
        verify(securityHubClient, times(1)).getFindings(any(GetFindingsRequest.class));
    }

    @Test
    void testGetAllVulnerabilities_Exception() {
        // Arrange
        when(securityHubClient.getFindings(any(GetFindingsRequest.class)))
                .thenThrow(SecurityHubException.builder().message("AWS Error").build());

        // Act & Assert
        RuntimeException exception = assertThrows(RuntimeException.class,
                () -> vulnerabilityService.getAllVulnerabilities());
        assertTrue(exception.getMessage().contains("Failed to fetch security findings"));
    }

    @Test
    void testGetVulnerabilitiesBySeverity_Success() {
        // Arrange
        AwsSecurityFinding finding = createMockFinding();
        GetFindingsResponse response = GetFindingsResponse.builder()
                .findings(List.of(finding))
                .build();

        when(securityHubClient.getFindings(any(GetFindingsRequest.class))).thenReturn(response);

        // Act
        List<VulnerabilityResponse> result = vulnerabilityService.getVulnerabilitiesBySeverity("CRITICAL");

        // Assert
        assertNotNull(result);
        assertEquals(1, result.size());
        assertEquals("CRITICAL", result.get(0).getSeverity());
        verify(securityHubClient, times(1)).getFindings(any(GetFindingsRequest.class));
    }

    @Test
    void testGetVulnerabilityById_Success() {
        // Arrange
        AwsSecurityFinding finding = createMockFinding();
        GetFindingsResponse response = GetFindingsResponse.builder()
                .findings(List.of(finding))
                .build();

        when(securityHubClient.getFindings(any(GetFindingsRequest.class))).thenReturn(response);

        // Act
        VulnerabilityResponse result = vulnerabilityService.getVulnerabilityById("test-finding-id");

        // Assert
        assertNotNull(result);
        assertEquals("test-finding-id", result.getFindingId());
        verify(securityHubClient, times(1)).getFindings(any(GetFindingsRequest.class));
    }

    @Test
    void testGetVulnerabilityById_NotFound() {
        // Arrange
        GetFindingsResponse response = GetFindingsResponse.builder()
                .findings(Collections.emptyList())
                .build();

        when(securityHubClient.getFindings(any(GetFindingsRequest.class))).thenReturn(response);

        // Act & Assert
        RuntimeException exception = assertThrows(RuntimeException.class,
                () -> vulnerabilityService.getVulnerabilityById("non-existent-id"));
        assertTrue(exception.getMessage().contains("Security finding not found"));
    }

    private AwsSecurityFinding createMockFinding() {
        return AwsSecurityFinding.builder()
                .id("test-finding-id")
                .title("Test Vulnerability")
                .description("Test description")
                .severity(Severity.builder().label(SeverityLabel.CRITICAL).build())
                .workflowState(WorkflowState.NEW)
                .resources(List.of(
                        Resource.builder()
                                .id("resource-123")
                                .type("AwsEc2Instance")
                                .build()
                ))
                .firstObservedAt(Instant.now().toString())
                .lastObservedAt(Instant.now().toString())
                .build();
    }
}
