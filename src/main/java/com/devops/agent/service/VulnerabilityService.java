package com.devops.agent.service;

import com.devops.agent.model.VulnerabilityResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import software.amazon.awssdk.services.securityhub.SecurityHubClient;
import software.amazon.awssdk.services.securityhub.model.*;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Slf4j
@RequiredArgsConstructor
public class VulnerabilityService {

    private final SecurityHubClient securityHubClient;

    /**
     * Get all active security findings (vulnerabilities)
     */
    public List<VulnerabilityResponse> getAllVulnerabilities() {
        log.info("Fetching all active security findings from Security Hub");
        try {
            // Build filter to get active findings
            AwsSecurityFindingFilters filters = AwsSecurityFindingFilters.builder()
                    .recordState(List.of(
                            StringFilter.builder()
                                    .comparison(StringFilterComparison.EQUALS)
                                    .value("ACTIVE")
                                    .build()
                    ))
                    .build();

            GetFindingsRequest request = GetFindingsRequest.builder()
                    .filters(filters)
                    .maxResults(100)
                    .build();

            GetFindingsResponse response = securityHubClient.getFindings(request);
            return mapFindingsToResponse(response.findings());
        } catch (SecurityHubException e) {
            log.error("Error fetching security findings: {}", e.getMessage());
            throw new RuntimeException("Failed to fetch security findings", e);
        }
    }

    /**
     * Get vulnerabilities filtered by severity
     */
    public List<VulnerabilityResponse> getVulnerabilitiesBySeverity(String severity) {
        log.info("Fetching security findings with severity: {}", severity);
        try {
            // Build filter for active findings with specified severity
            AwsSecurityFindingFilters filters = AwsSecurityFindingFilters.builder()
                    .recordState(List.of(
                            StringFilter.builder()
                                    .comparison(StringFilterComparison.EQUALS)
                                    .value("ACTIVE")
                                    .build()
                    ))
                    .severityLabel(List.of(
                            StringFilter.builder()
                                    .comparison(StringFilterComparison.EQUALS)
                                    .value(severity.toUpperCase())
                                    .build()
                    ))
                    .build();

            GetFindingsRequest request = GetFindingsRequest.builder()
                    .filters(filters)
                    .maxResults(100)
                    .build();

            GetFindingsResponse response = securityHubClient.getFindings(request);
            return mapFindingsToResponse(response.findings());
        } catch (SecurityHubException e) {
            log.error("Error fetching security findings by severity: {}", e.getMessage());
            throw new RuntimeException("Failed to fetch security findings by severity", e);
        }
    }

    /**
     * Get vulnerability details by finding ID
     */
    public VulnerabilityResponse getVulnerabilityById(String findingId) {
        log.info("Fetching security finding: {}", findingId);
        try {
            AwsSecurityFindingFilters filters = AwsSecurityFindingFilters.builder()
                    .id(List.of(
                            StringFilter.builder()
                                    .comparison(StringFilterComparison.EQUALS)
                                    .value(findingId)
                                    .build()
                    ))
                    .build();

            GetFindingsRequest request = GetFindingsRequest.builder()
                    .filters(filters)
                    .build();

            GetFindingsResponse response = securityHubClient.getFindings(request);

            if (response.findings().isEmpty()) {
                log.error("Security finding not found: {}", findingId);
                throw new RuntimeException("Security finding not found: " + findingId);
            }

            return mapFindingToResponse(response.findings().get(0));
        } catch (SecurityHubException e) {
            log.error("Error fetching security finding: {}", e.getMessage());
            throw new RuntimeException("Failed to fetch security finding", e);
        }
    }

    /**
     * Map multiple findings to response list
     */
    private List<VulnerabilityResponse> mapFindingsToResponse(List<AwsSecurityFinding> findings) {
        return findings.stream()
                .map(this::mapFindingToResponse)
                .collect(Collectors.toList());
    }

    /**
     * Map a single finding to VulnerabilityResponse
     */
    private VulnerabilityResponse mapFindingToResponse(AwsSecurityFinding finding) {
        List<String> resourceIds = new ArrayList<>();
        String resourceType = "Unknown";
        
        if (finding.resources() != null && !finding.resources().isEmpty()) {
            resourceIds = finding.resources().stream()
                    .map(Resource::id)
                    .collect(Collectors.toList());
            resourceType = finding.resources().get(0).type();
        }

        return VulnerabilityResponse.builder()
                .findingId(finding.id())
                .title(finding.title())
                .severity(finding.severity() != null ? finding.severity().labelAsString() : "UNKNOWN")
                .status(finding.workflowState() != null ? finding.workflowState().toString() : "NEW")
                .description(finding.description())
                .resourceType(resourceType)
                .resourceIds(resourceIds)
                .firstObservedAt(finding.firstObservedAt() != null ? finding.firstObservedAt().toString() : null)
                .lastObservedAt(finding.lastObservedAt() != null ? finding.lastObservedAt().toString() : null)
                .remediationText(extractRemediationText(finding))
                .complianceStatus(finding.compliance() != null ? finding.compliance().statusAsString() : null)
                .build();
    }

    /**
     * Extract remediation text from finding
     */
    private String extractRemediationText(AwsSecurityFinding finding) {
        if (finding.remediation() != null && finding.remediation().recommendation() != null) {
            return finding.remediation().recommendation().text();
        }
        return null;
    }
}
